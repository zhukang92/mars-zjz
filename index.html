<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro ç«æ˜Ÿè¯ä»¶ç…§ç”Ÿæˆå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <style>
        :root {
            --primary: #4f46e5; /* é«˜çº§è“ç´« */
            --primary-hover: #4338ca;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #111827;
            --border: #e5e7eb;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .header { text-align: center; margin-bottom: 24px; }
        h1 { margin: 0; font-size: 24px; font-weight: 800; color: #1f2937; }
        .subtitle { font-size: 14px; color: #6b7280; margin-top: 8px; }

        .workspace {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            justify-content: center;
            width: 100%;
            max-width: 1100px;
            align-items: flex-start;
        }

        /* å·¦ä¾§è®¾ç½®é¢æ¿ */
        .panel {
            background: var(--card);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            flex: 1;
            min-width: 320px;
            max-width: 400px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ä¸Šä¼ æŒ‰é’® */
        .upload-box {
            border: 2px dashed var(--primary);
            background: #eef2ff;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .upload-box:hover { background: #e0e7ff; }
        .upload-box input {
            position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;
        }
        .upload-label { color: var(--primary); font-weight: 600; font-size: 15px; }

        /* è§„æ ¼ç½‘æ ¼ */
        .size-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .size-btn {
            padding: 10px;
            border: 1px solid var(--border);
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: 0.2s;
        }
        .size-btn.active {
            border-color: var(--primary);
            background: #eef2ff;
            color: var(--primary);
        }
        .size-name { font-size: 14px; font-weight: 600; display: block; }
        .size-dim { font-size: 11px; color: #9ca3af; display: block; margin-top: 2px; }

        /* é¢œè‰²é€‰æ‹© */
        .color-row { display: flex; gap: 12px; margin-bottom: 20px; }
        .color-dot {
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            border: 2px solid #eee; position: relative; transition: transform 0.2s;
        }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { border-color: #333; }
        .color-dot.active::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 8px; height: 8px;
            background: #fff; border-radius: 50%; box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        /* æ»‘æ†æ§åˆ¶ */
        .slider-group { margin-bottom: 16px; }
        .slider-label { font-size: 12px; color: #6b7280; display: flex; justify-content: space-between; margin-bottom: 4px; }
        input[type=range] {
            width: 100%; -webkit-appearance: none; height: 6px; background: #e5e7eb; border-radius: 5px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; background: var(--primary); border-radius: 50%; cursor: pointer;
        }

        /* å³ä¾§é¢„è§ˆ */
        .preview-panel {
            background: var(--card);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 300px;
        }

        .canvas-container {
            position: relative;
            margin-bottom: 20px;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%), linear-gradient(-45deg, #eee 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #eee 75%), linear-gradient(-45deg, transparent 75%, #eee 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        canvas { display: block; cursor: move; max-width: 100%; height: auto; }

        .download-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            transition: 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .download-btn:hover { background: var(--primary-hover); }

        /* åŠ è½½åŠ¨ç”» */
        .loader-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.95); z-index: 10;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 30px; height: 30px; border: 3px solid #e5e7eb;
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .workspace { flex-direction: column; }
            .panel, .preview-panel { width: 100%; max-width: none; box-sizing: border-box; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Pro ç«æ˜Ÿè¯ä»¶ç…§ç”Ÿæˆå™¨</h1>
        <div class="subtitle">AI è‡ªåŠ¨æŠ å›¾ / è¾¹ç¼˜ç¾½åŒ– / é«˜æ¸…è¾“å‡º</div>
    </div>

    <div class="workspace">
        <div class="panel">
            <div class="upload-box">
                <div class="upload-label" id="upload-text">ğŸ“ ç‚¹å‡»ä¸Šä¼ äººåƒç…§ç‰‡</div>
                <input type="file" id="image-upload" accept="image/*" onchange="handleUpload(event)">
            </div>
            <p style="font-size:12px; color:#999; margin-top:8px; text-align:center;">å»ºè®®ä½¿ç”¨çº¯è‰²èƒŒæ™¯æˆ–å…‰çº¿å‡åŒ€çš„ç…§ç‰‡</p>

            <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

            <div class="section-title">é€‰æ‹©è§„æ ¼</div>
            <div class="size-grid" id="size-grid">
                </div>

            <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

            <div class="section-title">èƒŒæ™¯åº•è‰²</div>
            <div class="color-row">
                <div class="color-dot active" style="background:#fff;" onclick="setBg('white', this)" title="ç™½åº•"></div>
                <div class="color-dot" style="background:#438edb;" onclick="setBg('#438edb', this)" title="å¸¸è§„è“"></div>
                <div class="color-dot" style="background:#00bff3;" onclick="setBg('#00bff3', this)" title="æµ…è“(ç¤¾ä¿)"></div>
                <div class="color-dot" style="background:#d90000;" onclick="setBg('#d90000', this)" title="çº¢åº•"></div>
                <div class="color-dot" style="background:linear-gradient(180deg, #dcdce6 0%, #c5c5d6 100%);" onclick="setBg('gray', this)" title="é«˜çº§ç°"></div>
            </div>

            <div class="section-title">å½±æ£šç²¾ä¿® <span style="font-weight:normal; font-size:12px; color:#888;">(è°ƒèŠ‚åå®æ—¶ç”Ÿæ•ˆ)</span></div>
            
            <div class="slider-group">
                <div class="slider-label"><span>ğŸ“ äººç‰©ç¼©æ”¾</span> <span id="val-scale">1.0</span></div>
                <input type="range" min="0.5" max="2.5" step="0.05" value="1" oninput="updateParam('scale', this.value)">
            </div>

            <div class="slider-group">
                <div class="slider-label"><span>ğŸ’§ è¾¹ç¼˜ç¾½åŒ– (æ¶ˆé™¤æ¯›è¾¹)</span> <span id="val-blur">2.0</span></div>
                <input type="range" min="0" max="10" step="0.5" value="2" oninput="updateParam('edgeBlur', this.value)">
            </div>

            <div class="slider-group">
                <div class="slider-label"><span>â˜€ï¸ äº®åº¦è¡¥å¿</span> <span id="val-bright">0</span></div>
                <input type="range" min="-50" max="50" step="1" value="0" oninput="updateParam('brightness', this.value)">
            </div>
        </div>

        <div class="preview-panel">
            <div class="canvas-container">
                <div class="loader-overlay" id="loading">
                    <div class="spinner"></div>
                    <div style="margin-top:10px; font-size:13px; color:#666;">AI ç²¾ç»†æŠ å›¾ä¸­...</div>
                </div>
                <canvas id="preview-canvas" width="295" height="413"></canvas>
            </div>
            <p style="font-size:12px; color:#6b7280; margin-bottom:16px;">ğŸ‘† é¼ æ ‡æ‹–æ‹½å¯è°ƒæ•´ä½ç½®ï¼Œæ»šè½®ç¼©æ”¾</p>
            <button class="download-btn" onclick="downloadImg()">
                ğŸ“¥ ä¸‹è½½é«˜æ¸…è¯ä»¶ç…§ (300DPI)
            </button>
        </div>
    </div>

    <script>
        // === å¸¸é‡å®šä¹‰ (300 DPI æ ‡å‡†åƒç´ ) ===
        const PRESETS = {
            '1inch': { name: '1 å¯¸', dim: '25x35 mm', w: 295, h: 413 },
            'small2': { name: 'å° 2 å¯¸ (æŠ¤ç…§/å…¬åŠ¡å‘˜)', dim: '33x48 mm', w: 390, h: 567 },
            '2inch': { name: '2 å¯¸', dim: '35x49 mm', w: 413, h: 579 },
            'big1':  { name: 'å¤§ 1 å¯¸ (åŒ»ä¿/ç¤¾ä¿)', dim: '33x48 mm', w: 390, h: 567 },
            '5inch': { name: '5 å¯¸', dim: '89x127 mm', w: 1050, h: 1499 },
            'visa':  { name: 'ç­¾è¯ (ç¾å›½/æ—¥æœ¬)', dim: '50x50 mm', w: 591, h: 591 }
        };

        // === çŠ¶æ€ç®¡ç† ===
        const state = {
            sourceImg: null,   // åŸå§‹å›¾
            maskImg: null,     // è’™ç‰ˆå›¾
            currentPreset: '1inch',
            bgColor: 'white',
            bgGradient: false,
            
            // æ¸²æŸ“å‚æ•°
            scale: 1.0,
            posX: 0, 
            posY: 0,
            edgeBlur: 2.0,     // ç¾½åŒ–ç¨‹åº¦
            brightness: 0,     // äº®åº¦
            
            // äº¤äº’
            isDragging: false,
            lastX: 0, lastY: 0
        };

        let selfieSegmentation = null;
        const canvas = document.getElementById('preview-canvas');
        const ctx = canvas.getContext('2d');

        // === åˆå§‹åŒ– UI ===
        function initUI() {
            const grid = document.getElementById('size-grid');
            for (let key in PRESETS) {
                const p = PRESETS[key];
                const btn = document.createElement('div');
                btn.className = `size-btn ${key === '1inch' ? 'active' : ''}`;
                btn.innerHTML = `<span class="size-name">${p.name}</span><span class="size-dim">${p.dim}</span>`;
                btn.onclick = () => setPreset(key, btn);
                grid.appendChild(btn);
            }
        }
        initUI();

        // === åˆå§‹åŒ– MediaPipe ===
        async function loadModel() {
            selfieSegmentation = new SelfieSegmentation({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`;
            }});
            selfieSegmentation.setOptions({ modelSelection: 1 }); // 1 = Landscape (æ›´ç²¾å‡†)
            selfieSegmentation.onResults(handleSegmentationResults);
        }
        loadModel();

        // === æ ¸å¿ƒä¸šåŠ¡ ===

        function handleUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('upload-text').innerText = "æ­£åœ¨åˆ†æäººåƒ...";

            const reader = new FileReader();
            reader.onload = (evt) => {
                const img = new Image();
                img.src = evt.target.result;
                img.onload = async () => {
                    state.sourceImg = img;
                    // é‡ç½®ä½ç½®
                    state.posX = 0;
                    state.posY = 0;
                    if (!selfieSegmentation) await loadModel();
                    await selfieSegmentation.send({image: img});
                }
            };
            reader.readAsDataURL(file);
        }

        function handleSegmentationResults(results) {
            // 1. æå–è’™ç‰ˆ (Mask)
            const maskCanvas = document.createElement('canvas');
            maskCanvas.width = results.image.width;
            maskCanvas.height = results.image.height;
            const maskCtx = maskCanvas.getContext('2d');
            
            // ç»˜åˆ¶çº¯é»‘ç™½è’™ç‰ˆ (ç™½è‰²ä¸ºäººåƒ)
            maskCtx.drawImage(results.segmentationMask, 0, 0, maskCanvas.width, maskCanvas.height);
            
            // ä¿å­˜è’™ç‰ˆ
            const maskImg = new Image();
            maskImg.src = maskCanvas.toDataURL();
            maskImg.onload = () => {
                state.maskImg = maskImg;
                autoFit(); // è‡ªåŠ¨é€‚é…å¤§å°
                render();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('upload-text').innerText = "æ›´æ¢ç…§ç‰‡";
            };
        }

        // è‡ªåŠ¨ç¼©æ”¾ï¼Œè®©äººåƒé»˜è®¤å¡«å…… 75% é«˜åº¦
        function autoFit() {
            if (!state.maskImg) return;
            const targetH = PRESETS[state.currentPreset].h;
            const imgH = state.maskImg.height;
            state.scale = (targetH * 0.75) / imgH;
            document.getElementById('val-scale').innerText = state.scale.toFixed(2);
            document.querySelector('input[oninput*="scale"]').value = state.scale;
            // å±…ä¸­ç¨å¾®åä¸‹
            state.posY = targetH * 0.05; 
        }

        // === æ¸²æŸ“å¼•æ“ (æ ¸å¿ƒç®—æ³•) ===
        function render() {
            if (!state.sourceImg || !state.maskImg) return;

            const preset = PRESETS[state.currentPreset];
            canvas.width = preset.w;
            canvas.height = preset.h;

            // 1. ç»˜åˆ¶èƒŒæ™¯
            if (state.bgGradient) {
                const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                grad.addColorStop(0, '#dcdce6');
                grad.addColorStop(1, '#c5c5d6');
                ctx.fillStyle = grad;
            } else {
                ctx.fillStyle = state.bgColor;
            }
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 2. è®¡ç®—äººåƒä½ç½®å‚æ•°
            const imgW = state.sourceImg.width * state.scale;
            const imgH = state.sourceImg.height * state.scale;
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const drawX = cx - imgW / 2 + state.posX;
            const drawY = cy - imgH / 2 + state.posY;

            // 3. ç¦»å±åˆæˆ (å¤„ç†ç¾½åŒ–å’Œæ»¤é•œ)
            const tempCvs = document.createElement('canvas');
            tempCvs.width = canvas.width;
            tempCvs.height = canvas.height;
            const tempCtx = tempCvs.getContext('2d');

            // A. ç»˜åˆ¶æ¨¡ç³Šçš„è’™ç‰ˆ (å®ç°ç¾½åŒ–)
            // è¿™ä¸€æ­¥æ˜¯è§£å†³â€œæ¯›è¾¹â€çš„å…³é”®
            if (state.edgeBlur > 0) {
                tempCtx.filter = `blur(${state.edgeBlur}px)`;
            }
            tempCtx.drawImage(state.maskImg, drawX, drawY, imgW, imgH);
            tempCtx.filter = 'none'; // é‡ç½®

            // B. åº”ç”¨åŸå›¾åˆ°è’™ç‰ˆ (Source-In)
            tempCtx.globalCompositeOperation = 'source-in';
            
            // C. åœ¨ç»˜åˆ¶åŸå›¾å‰ï¼Œåº”ç”¨äº®åº¦/å¯¹æ¯”åº¦æ»¤é•œ
            tempCtx.filter = `brightness(${100 + parseInt(state.brightness)}%)`;
            tempCtx.drawImage(state.sourceImg, drawX, drawY, imgW, imgH);

            // 4. å°†å¤„ç†å¥½çš„äººåƒç»˜åˆ¶å›ä¸»ç”»å¸ƒ
            ctx.drawImage(tempCvs, 0, 0);
        }

        // === äº¤äº’æ§åˆ¶ ===

        function setPreset(key, btn) {
            state.currentPreset = key;
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render();
        }

        function setBg(color, btn) {
            state.bgGradient = (color === 'gray');
            state.bgColor = color;
            document.querySelectorAll('.color-dot').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render();
        }

        function updateParam(key, val) {
            state[key] = parseFloat(val);
            // æ›´æ–°æ˜¾ç¤ºçš„æ•°å€¼
            if(document.getElementById(`val-${key === 'edgeBlur' ? 'blur' : (key === 'brightness' ? 'bright' : key)}`)) {
                document.getElementById(`val-${key === 'edgeBlur' ? 'blur' : (key === 'brightness' ? 'bright' : key)}`).innerText = val;
            }
            render();
        }

        // æ‹–æ‹½é€»è¾‘
        canvas.addEventListener('mousedown', e => { state.isDragging = true; state.lastX = e.clientX; state.lastY = e.clientY; });
        window.addEventListener('mouseup', () => state.isDragging = false);
        window.addEventListener('mousemove', e => {
            if (!state.isDragging) return;
            state.posX += (e.clientX - state.lastX);
            state.posY += (e.clientY - state.lastY);
            state.lastX = e.clientX; state.lastY = e.clientY;
            render();
        });
        
        // è§¦æ‘¸æ”¯æŒ
        canvas.addEventListener('touchstart', e => { state.isDragging = true; state.lastX = e.touches[0].clientX; state.lastY = e.touches[0].clientY; }, {passive: false});
        window.addEventListener('touchend', () => state.isDragging = false);
        window.addEventListener('touchmove', e => {
            if (!state.isDragging) return;
            e.preventDefault();
            state.posX += (e.touches[0].clientX - state.lastX);
            state.posY += (e.touches[0].clientY - state.lastY);
            state.lastX = e.touches[0].clientX; state.lastY = e.touches[0].clientY;
            render();
        }, {passive: false});
        
        // æ»šè½®ç¼©æ”¾
        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.05 : 0.05;
            let newScale = Math.max(0.5, Math.min(3.0, state.scale + delta));
            updateParam('scale', newScale.toFixed(2));
            document.querySelector('input[oninput*="scale"]').value = newScale;
        });

        function downloadImg() {
            if (!state.sourceImg) return alert("è¯·å…ˆä¸Šä¼ ç…§ç‰‡");
            const link = document.createElement('a');
            link.download = `Studio_Photo_${state.currentPreset}_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png', 1.0); // æœ€é«˜è´¨é‡
            link.click();
        }
    </script>
</body>
</html>
