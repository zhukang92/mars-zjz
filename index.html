<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«æ˜Ÿè¯ä»¶ç…§ç”Ÿæˆå™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { text-align: center; margin-bottom: 20px; color: #333; }

        .main-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            width: 100%;
            max-width: 1000px;
        }

        /* å·¦ä¾§æ§åˆ¶åŒº */
        .controls {
            background: var(--card);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group { display: flex; flex-direction: column; gap: 10px; }
        .control-label { font-weight: bold; font-size: 14px; color: #64748b; }

        /* ä¸Šä¼ æŒ‰é’® */
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .btn-upload {
            border: 2px dashed var(--primary);
            color: var(--primary);
            background-color: #eff6ff;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            text-align: center;
            box-sizing: border-box;
            transition: all 0.2s;
        }
        .btn-upload:hover { background-color: #dbeafe; }
        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* é€‰é¡¹æŒ‰é’®ç½‘æ ¼ */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }

        .option-btn {
            padding: 10px;
            border: 1px solid var(--border);
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .option-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* é¢œè‰²é€‰æ‹©åœ†åœˆ */
        .color-grid { display: flex; gap: 15px; }
        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            position: relative;
        }
        .color-btn.active::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
        }

        /* å³ä¾§é¢„è§ˆåŒº */
        .preview-area {
            background: var(--card);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            min-width: 320px;
        }

        canvas {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgZmlsbC1vcGFjaXR5PSIwLjEiPjxwYXRoIGQ9Ik0xMCAwaDEwdjEwSDEweiIgZmlsbD0iIzAwMCIvPjxwYXRoIGQ9Ik0wIDEwaDEwdjEwSDB6IiBmaWxsPSIjMDAwIi8+PC9zdmc+');
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            cursor: move; /* æç¤ºå¯æ‹–åŠ¨ */
            max-width: 100%;
            max-height: 60vh;
        }

        .tips {
            margin-top: 15px;
            font-size: 13px;
            color: #64748b;
            text-align: center;
        }

        .download-btn {
            margin-top: 20px;
            padding: 12px 40px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        /* åŠ è½½é®ç½© */
        #loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 16px;
            display: none;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ‰‹æœºé€‚é… */
        @media (max-width: 700px) {
            .main-container { flex-direction: column; }
            .controls, .preview-area { width: 100%; min-width: auto; box-sizing: border-box; }
        }
    </style>
</head>
<body>

    <h1>ğŸ“· ç«æ˜Ÿè¯ä»¶ç…§ç”Ÿæˆå™¨</h1>

    <div class="main-container">
        <div class="controls">
            <div class="control-group">
                <div class="control-label">1. ä¸Šä¼ ç…§ç‰‡ (å»ºè®®æ­£é¢/å…‰çº¿å‡åŒ€)</div>
                <div class="upload-btn-wrapper">
                    <div class="btn-upload" id="upload-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</div>
                    <input type="file" id="image-upload" accept="image/*" onchange="handleImageUpload(event)">
                </div>
            </div>

            <div class="control-group">
                <div class="control-label">2. é€‰æ‹©å°ºå¯¸</div>
                <div class="options-grid" id="size-options">
                    <button class="option-btn active" onclick="setSize('1inch')">1 å¯¸<br><span style="font-size:10px">25x35mm</span></button>
                    <button class="option-btn" onclick="setSize('1.5inch')">1.5 å¯¸<br><span style="font-size:10px">33x48mm</span></button>
                    <button class="option-btn" onclick="setSize('2inch')">2 å¯¸<br><span style="font-size:10px">35x49mm</span></button>
                    <button class="option-btn" onclick="setSize('3inch')">3 å¯¸<br><span style="font-size:10px">55x84mm</span></button>
                    <button class="option-btn" onclick="setSize('5inch')">5 å¯¸<br><span style="font-size:10px">89x127mm</span></button>
                </div>
            </div>

            <div class="control-group">
                <div class="control-label">3. é€‰æ‹©åº•è‰²</div>
                <div class="color-grid">
                    <div class="color-btn active" style="background:white; border-color:#ccc;" onclick="setColor('white', this)"></div>
                    <div class="color-btn" style="background:#438edb;" onclick="setColor('#438edb', this)"></div> <div class="color-btn" style="background:#d90000;" onclick="setColor('#d90000', this)"></div> <div class="color-btn" style="background:linear-gradient(180deg, #e0e7ef 0%, #cfdaeb 100%);" onclick="setColor('business', this)"></div> </div>
            </div>
            
            <div class="control-group">
                <div class="control-label">4. å¾®è°ƒ (ä¹Ÿå¯ä»¥ç›´æ¥æ‹–æ‹½å›¾ç‰‡)</div>
                <input type="range" id="scale-slider" min="0.5" max="3" step="0.1" value="1" oninput="updateScale(this.value)">
            </div>
        </div>

        <div class="preview-area">
            <div id="loading-overlay">
                <div class="spinner"></div>
                <p style="margin-top:10px;">AI æ­£åœ¨æŠ å›¾ä¸­...</p>
            </div>
            <canvas id="main-canvas" width="295" height="413"></canvas>
            <p class="tips">ğŸ’¡ æç¤ºï¼šé¼ æ ‡/æ‰‹æŒ‡æ‹–åŠ¨å¯è°ƒæ•´äººåƒä½ç½®ï¼Œæ»šè½®å¯ç¼©æ”¾</p>
            <button class="download-btn" onclick="downloadImage()">ğŸ’¾ ä¿å­˜é«˜æ¸…è¯ä»¶ç…§</button>
        </div>
    </div>

    <script>
        // === é…ç½®ä¸å˜é‡ ===
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        const loading = document.getElementById('loading-overlay');

        // å°ºå¯¸å®šä¹‰ (300DPI ä¸‹çš„åƒç´ å€¼)
        const SIZES = {
            '1inch': { w: 295, h: 413 },
            '1.5inch': { w: 390, h: 567 }, // å°2å¯¸
            '2inch': { w: 413, h: 579 },
            '3inch': { w: 649, h: 991 },
            '5inch': { w: 1050, h: 1499 }
        };

        let state = {
            originalImg: null,  // åŸå§‹å›¾ç‰‡å¯¹è±¡
            cutoutImg: null,    // æŠ å›¾åçš„å›¾ç‰‡ï¼ˆImageBitmap æˆ– Canvasï¼‰
            currentSize: '1inch',
            bgColor: 'white',
            bgGradient: false,
            posX: 0,
            posY: 0,
            scale: 1,
            isDragging: false,
            lastMouseX: 0,
            lastMouseY: 0
        };

        // === åˆå§‹åŒ– MediaPipe ===
        let selfieSegmentation = null;
        
        async function initMediaPipe() {
            selfieSegmentation = new SelfieSegmentation({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`;
            }});
            selfieSegmentation.setOptions({
                modelSelection: 1, // 0 general, 1 landscape (better for distance)
            });
            selfieSegmentation.onResults(onSegmentationResults);
        }

        initMediaPipe();

        // === æ ¸å¿ƒé€»è¾‘ï¼šå›¾ç‰‡å¤„ç† ===
        
        // 1. å¤„ç†ä¸Šä¼ 
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            loading.style.display = 'flex';
            document.getElementById('upload-text').innerText = "å¤„ç†ä¸­...";

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = async () => {
                    state.originalImg = img;
                    
                    // å‘é€ç»™ MediaPipe è¿›è¡Œå¤„ç†
                    if (selfieSegmentation) {
                        await selfieSegmentation.send({image: img});
                    } else {
                        alert("AIæ¨¡å‹å°šæœªåŠ è½½å®Œæˆï¼Œè¯·åˆ·æ–°é‡è¯•");
                        loading.style.display = 'none';
                    }
                };
            };
            reader.readAsDataURL(file);
        }

        // 2. AI æŠ å›¾å›è°ƒ
        function onSegmentationResults(results) {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ Canvas æ¥å­˜æ”¾æŠ å¥½çš„äººåƒ
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = results.image.width;
            tempCanvas.height = results.image.height;
            const tempCtx = tempCanvas.getContext('2d');

            // æ¸…ç©º
            tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);

            // ç»˜åˆ¶è’™ç‰ˆ
            tempCtx.drawImage(results.segmentationMask, 0, 0, results.image.width, results.image.height);

            // ä½¿ç”¨ composite æ“ä½œä¿ç•™äººåƒéƒ¨åˆ†
            tempCtx.globalCompositeOperation = 'source-in';
            tempCtx.drawImage(results.image, 0, 0, results.image.width, results.image.height);

            // å°†ç»“æœä¿å­˜ä¸º Image å¯¹è±¡ä»¥ä¾¿åç»­é¢‘ç¹ç»˜åˆ¶
            const cutout = new Image();
            cutout.src = tempCanvas.toDataURL();
            cutout.onload = () => {
                state.cutoutImg = cutout;
                resetPosition();
                draw();
                loading.style.display = 'none';
                document.getElementById('upload-text').innerText = "æ›´æ¢å›¾ç‰‡";
            };
        }

        // 3. ç»˜åˆ¶ä¸»ç”»å¸ƒ
        function draw() {
            const size = SIZES[state.currentSize];
            canvas.width = size.w;
            canvas.height = size.h;

            // A. å¡«å……èƒŒæ™¯
            if (state.bgGradient) {
                const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                grad.addColorStop(0, '#e0e7ef');
                grad.addColorStop(1, '#cfdaeb');
                ctx.fillStyle = grad;
            } else {
                ctx.fillStyle = state.bgColor;
            }
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // B. ç»˜åˆ¶äººåƒ (å¦‚æœæœ‰)
            if (state.cutoutImg) {
                const imgW = state.cutoutImg.width * state.scale;
                const imgH = state.cutoutImg.height * state.scale;
                
                // å±…ä¸­åæ ‡
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                ctx.drawImage(
                    state.cutoutImg, 
                    centerX - imgW/2 + state.posX, 
                    centerY - imgH/2 + state.posY, 
                    imgW, 
                    imgH
                );
            }
        }

        // === äº¤äº’é€»è¾‘ ===

        function setSize(sizeKey) {
            state.currentSize = sizeKey;
            // åˆ‡æ¢æŒ‰é’®æ ·å¼
            document.querySelectorAll('#size-options .option-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            resetPosition(); // å°ºå¯¸æ”¹å˜æ—¶é‡ç½®ä½ç½®æ¯”è¾ƒåˆç†
            draw();
        }

        function setColor(color, btn) {
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (color === 'business') {
                state.bgGradient = true;
            } else {
                state.bgGradient = false;
                state.bgColor = color;
            }
            draw();
        }

        function updateScale(val) {
            state.scale = parseFloat(val);
            draw();
        }

        function resetPosition() {
            // è‡ªåŠ¨è®¡ç®—åˆé€‚çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿äººåƒå¡«æ»¡é«˜åº¦çš„ 70%
            if (state.cutoutImg) {
                const canvasH = SIZES[state.currentSize].h;
                const imgH = state.cutoutImg.height;
                // åˆå§‹ç¼©æ”¾ï¼šè®©äººåƒé«˜åº¦å¤§çº¦å ç”»å¸ƒçš„ 80%
                state.scale = (canvasH * 0.8) / imgH; 
                document.getElementById('scale-slider').value = state.scale;
            }
            state.posX = 0;
            state.posY = 0; // ç¨å¾®å¾€ä¸‹ä¸€ç‚¹
        }

        // æ‹–æ‹½äº‹ä»¶
        canvas.addEventListener('mousedown', e => {
            state.isDragging = true;
            state.lastMouseX = e.clientX;
            state.lastMouseY = e.clientY;
        });

        window.addEventListener('mouseup', () => state.isDragging = false);

        window.addEventListener('mousemove', e => {
            if (!state.isDragging) return;
            e.preventDefault();
            const dx = e.clientX - state.lastMouseX;
            const dy = e.clientY - state.lastMouseY;
            state.posX += dx;
            state.posY += dy;
            state.lastMouseX = e.clientX;
            state.lastMouseY = e.clientY;
            draw();
        });

        // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
        canvas.addEventListener('touchstart', e => {
            state.isDragging = true;
            state.lastMouseX = e.touches[0].clientX;
            state.lastMouseY = e.touches[0].clientY;
        }, {passive: false});

        window.addEventListener('touchend', () => state.isDragging = false);

        window.addEventListener('touchmove', e => {
            if (!state.isDragging) return;
            e.preventDefault(); // é˜²æ­¢æ»šåŠ¨é¡µé¢
            const dx = e.touches[0].clientX - state.lastMouseX;
            const dy = e.touches[0].clientY - state.lastMouseY;
            state.posX += dx;
            state.posY += dy;
            state.lastMouseX = e.touches[0].clientX;
            state.lastMouseY = e.touches[0].clientY;
            draw();
        }, {passive: false});

        // æ»šè½®ç¼©æ”¾
        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.05 : 0.05;
            state.scale = Math.max(0.1, state.scale + delta);
            document.getElementById('scale-slider').value = state.scale;
            draw();
        });

        // ä¸‹è½½
        function downloadImage() {
            if (!state.cutoutImg) {
                alert("è¯·å…ˆä¸Šä¼ ç…§ç‰‡");
                return;
            }
            const link = document.createElement('a');
            link.download = `ID_Photo_${state.currentSize}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }
    </script>
</body>
</html>