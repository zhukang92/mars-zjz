<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç«æ˜Ÿè¯ä»¶ç…§ - ä½ çš„æŒä¸Šç…§ç›¸é¦†</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        :root {
            --brand: #07c160; /* å¾®ä¿¡é£æ ¼ç»¿ï¼Œå¢åŠ ä¿¡ä»»æ„Ÿ */
            --brand-dark: #06ad56;
            --accent: #ff6b00; /* ç«æ˜Ÿæ©™ */
            --bg: #f7f8fa;
            --card: #ffffff;
            --text-main: #111;
            --text-sub: #666;
            --shadow: 0 8px 30px rgba(0,0,0,0.06);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, "PingFang SC", "Helvetica Neue", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            width: 100%;
            background: var(--card);
            padding: 16px 20px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .logo span { color: var(--accent); }
        .contact-pill {
            font-size: 12px; background: #f0fdf4; color: var(--brand); padding: 6px 12px; 
            border-radius: 20px; font-weight: 600; cursor: pointer; border: 1px solid #dcfce7;
        }

        /* ä¸»å·¥ä½œåŒº */
        .workspace {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            padding: 30px 20px;
            width: 100%;
            max-width: 1100px;
            justify-content: center;
        }

        /* å·¦ä¾§ï¼šç”»å¸ƒé¢„è§ˆ */
        .preview-area {
            flex: 1;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .canvas-wrapper {
            position: relative;
            box-shadow: var(--shadow);
            border-radius: 8px;
            overflow: hidden;
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%), linear-gradient(-45deg, #eee 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #eee 75%), linear-gradient(-45deg, transparent 75%, #eee 75%);
            background-size: 20px 20px;
            transition: transform 0.2s;
            /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œé˜²æ­¢å¤§å±å æ»¡ */
            max-height: 60vh; 
        }

        canvas {
            display: block;
            max-width: 100%;
            height: auto; /* ä¿æŒæ¯”ä¾‹ */
            cursor: grab;
        }
        canvas:active { cursor: grabbing; }

        .tips {
            margin-top: 15px;
            font-size: 13px;
            color: var(--text-sub);
            background: rgba(0,0,0,0.03);
            padding: 8px 16px;
            border-radius: 20px;
        }

        /* å³ä¾§ï¼šæ§åˆ¶é¢æ¿ */
        .controls-panel {
            flex: 1;
            min-width: 320px;
            max-width: 480px;
            background: var(--card);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .section { margin-bottom: 24px; }
        .section-header { font-size: 15px; font-weight: 700; margin-bottom: 12px; display: flex; justify-content: space-between; }
        
        /* ä¸Šä¼ ç»„ä»¶ */
        .upload-zone {
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }
        .upload-zone:hover { border-color: var(--brand); background: #f0fdf4; }
        .upload-icon { font-size: 32px; margin-bottom: 8px; display: block; }
        .upload-text { font-weight: 600; color: var(--text-main); }
        .upload-sub { font-size: 12px; color: var(--text-sub); margin-top: 4px; }

        /* èƒŒæ™¯é€‰æ‹©å™¨ (è§†è§‰å‡çº§) */
        .bg-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .bg-card {
            border: 2px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .bg-card:hover { transform: translateY(-2px); }
        .bg-card.active { border-color: var(--brand); box-shadow: 0 4px 12px rgba(7, 193, 96, 0.2); }
        
        .bg-preview { height: 40px; width: 100%; }
        .bg-name { font-size: 12px; text-align: center; padding: 6px; background: #fff; font-weight: 500; }
        
        /* å°ºå¯¸èƒ¶å›Š */
        .size-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: none; /* Firefox */
        }
        .size-scroll::-webkit-scrollbar { display: none; }
        
        .size-pill {
            flex: 0 0 auto;
            padding: 8px 16px;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid transparent;
            text-align: center;
        }
        .size-pill.active {
            background: #e6fffa; color: var(--brand-dark); border-color: var(--brand); font-weight: bold;
        }
        .size-dim { font-size: 10px; opacity: 0.7; display: block; }

        /* æ»‘æ†ç²¾ä¿® */
        .slider-row {
            display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
        }
        .slider-icon { font-size: 16px; width: 20px; text-align: center; }
        input[type=range] {
            flex: 1; -webkit-appearance: none; height: 4px; background: #e0e0e0; border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; background: #fff; border: 2px solid var(--brand); border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* åº•éƒ¨ä¸‹è½½æ  */
        .action-bar {
            margin-top: 30px;
        }
        .btn-download {
            width: 100%;
            padding: 16px;
            background: var(--brand);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(7, 193, 96, 0.3);
            transition: 0.2s;
        }
        .btn-download:hover { background: var(--brand-dark); }
        .footer-note {
            text-align: center; font-size: 12px; color: #999; margin-top: 16px;
        }

        /* Loading */
        #loading-mask {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.9); z-index: 50;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 32px; height: 32px; border: 3px solid #eee; border-top-color: var(--brand);
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* å¼¹çª— */
        .modal {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 16px; width: 80%; max-width: 320px; text-align: center;
        }

        @media (max-width: 768px) {
            .navbar { padding: 12px 16px; }
            .workspace { padding: 10px; gap: 20px; }
            .preview-area { order: 1; } /* é¢„è§ˆåœ¨å…ˆ */
            .controls-panel { order: 2; padding: 20px; } /* æ§åˆ¶åœ¨å */
            .bg-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">ğŸª <span>ç«æ˜Ÿè¯ä»¶ç…§</span></div>
        <div class="contact-pill" onclick="showContact()">
            ğŸ’¬ è”ç³»å®¢æœ / å®šåˆ¶å¼€å‘
        </div>
    </nav>

    <div class="workspace">
        
        <div class="preview-area">
            <div class="canvas-wrapper">
                <div id="loading-mask">
                    <div class="spinner"></div>
                    <div style="font-size:12px; color:#666; font-weight:bold;">AI æ­£åœ¨ç²¾ä¿®æŠ å›¾...</div>
                </div>
                <canvas id="main-canvas" width="295" height="413"></canvas>
            </div>
            <div class="tips">ğŸ‘† åŒæŒ‡/æ»šè½®ç¼©æ”¾ï¼Œå•æŒ‡æ‹–åŠ¨è°ƒæ•´ä½ç½®</div>
        </div>

        <div class="controls-panel">
            
            <div class="section">
                <div class="upload-zone" onclick="document.getElementById('file-input').click()">
                    <span class="upload-icon">ğŸ“·</span>
                    <div class="upload-text" id="upload-label">ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡</div>
                    <div class="upload-sub">æ”¯æŒæ‰‹æœºç›¸å†Œ / å»ºè®®çº¯è‰²èƒŒæ™¯</div>
                    <input type="file" id="file-input" accept="image/*" hidden onchange="handleFile(event)">
                </div>
            </div>

            <div class="section">
                <div class="section-header">é€‰æ‹©è§„æ ¼</div>
                <div class="size-scroll" id="size-list">
                    </div>
            </div>

            <div class="section">
                <div class="section-header">å½±æ£šèƒŒæ™¯</div>
                <div class="bg-grid">
                    <div class="bg-card active" onclick="setBg('white', this)">
                        <div class="bg-preview" style="background:#fff; border-bottom:1px solid #eee;"></div>
                        <div class="bg-name">ç®€çº¦ç™½</div>
                    </div>
                    <div class="bg-card" onclick="setBg('blue-std', this)">
                        <div class="bg-preview" style="background:#438edb;"></div>
                        <div class="bg-name">æ ‡å‡†è“</div>
                    </div>
                    <div class="bg-card" onclick="setBg('red-std', this)">
                        <div class="bg-preview" style="background:#d90000;"></div>
                        <div class="bg-name">æ ‡å‡†çº¢</div>
                    </div>
                    <div class="bg-card" onclick="setBg('blue-light', this)">
                        <div class="bg-preview" style="background:#66b5f3;"></div>
                        <div class="bg-name">ç¤¾ä¿è“</div>
                    </div>
                    <div class="bg-card" onclick="setBg('grad-blue', this)">
                        <div class="bg-preview" style="background:linear-gradient(180deg, #e3eaf4 0%, #c8d5e8 100%);"></div>
                        <div class="bg-name">å•†åŠ¡è“ç°</div>
                    </div>
                    <div class="bg-card" onclick="setBg('grad-gray', this)">
                        <div class="bg-preview" style="background:linear-gradient(180deg, #f0f0f0 0%, #d0d0d0 100%);"></div>
                        <div class="bg-name">é«˜çº§ç°</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">ç»†èŠ‚ç²¾ä¿®</div>
                
                <div class="slider-row">
                    <span class="slider-icon">ğŸ“</span>
                    <input type="range" min="0.5" max="2.0" step="0.01" value="1" id="scale-slider" oninput="updateParam('scale', this.value)">
                </div>

                <div class="slider-row" title="è¾¹ç¼˜æ”¶ç¼©ï¼šå»é™¤ç™½è¾¹">
                    <span class="slider-icon">âœ‚ï¸</span>
                    <input type="range" min="0" max="6" step="0.5" value="2" oninput="updateParam('erosion', this.value)">
                </div>

                <div class="slider-row" title="ç¾ç™½æäº®">
                    <span class="slider-icon">â˜€ï¸</span>
                    <input type="range" min="-20" max="40" step="1" value="10" oninput="updateParam('brightness', this.value)">
                </div>
            </div>

            <div class="action-bar">
                <button class="btn-download" onclick="downloadImage()">ä¿å­˜é«˜æ¸…è¯ä»¶ç…§</button>
                <div class="footer-note">ç«æ˜Ÿè¯ä»¶ç…§ç”Ÿæˆå™¨ Â© 2025 | å…è´¹å·¥å…·</div>
            </div>
        </div>
    </div>

    <div class="modal" id="contact-modal" onclick="this.style.display='none'">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 style="margin-top:0;">è”ç³»ä½œè€…</h3>
            <p style="color:#666; font-size:14px; line-height:1.6;">
                å¦‚éœ€å®šåˆ¶å¼€å‘ã€å•†ä¸šåˆä½œæˆ–åé¦ˆBug<br>è¯·æ·»åŠ å¾®ä¿¡
            </p>
            <div style="background:#f5f5f5; padding:10px; border-radius:8px; font-weight:bold; font-size:18px; margin:20px 0; color:#333;">
                m644003222
            </div>
            <p style="font-size:12px; color:#999;">å¤‡æ³¨ï¼šç«æ˜Ÿè¯ä»¶ç…§</p>
        </div>
    </div>

    <script>
        // === 1. é…ç½®æ•°æ® ===
        const SIZES = {
            '1inch': { name: '1å¯¸', desc: 'å¸¸è§„è¯ä»¶', w: 295, h: 413 },
            '2inch': { name: '2å¯¸', desc: 'æŠ¤ç…§/ç­¾è¯', w: 413, h: 579 },
            'small2': { name: 'å°2å¯¸', desc: 'å…¬åŠ¡å‘˜/ç¤¾ä¿', w: 390, h: 567 },
            'visa_us': { name: 'ç¾ç­¾', desc: '51x51mm', w: 602, h: 602 },
            'teacher': { name: 'æ•™èµ„', desc: '20-60k', w: 295, h: 413 }, // å°ºå¯¸åŒ1å¯¸ï¼Œä¸»è¦æ˜¯å¤§å°é™åˆ¶ï¼Œå‰ç«¯åªç®¡åƒç´ 
            '5inch': { name: '5å¯¸', desc: 'ç”Ÿæ´»ç…§', w: 1050, h: 1499 }
        };

        const BACKGROUNDS = {
            'white': '#ffffff',
            'blue-std': '#438edb', // å…¬å®‰è“
            'red-std': '#db3025',  // ç»“å©š/å…šå‘˜çº¢
            'blue-light': '#66b5f3', // æµ…è“
            'grad-blue': ['#e3eaf4', '#c8d5e8'], // å•†åŠ¡æ¸å˜
            'grad-gray': ['#f5f7fa', '#c3cfe2']  // ç®€å†ç°
        };

        // === 2. æ ¸å¿ƒçŠ¶æ€ (Stateless Logic) ===
        const state = {
            srcImg: null,    // åŸå›¾ Image å¯¹è±¡
            maskImg: null,   // è’™ç‰ˆ Image å¯¹è±¡
            
            // æ¸²æŸ“å‚æ•°
            sizeKey: '1inch',
            bgKey: 'white',
            scale: 1.0,
            posX: 0,
            posY: 0,
            erosion: 2.0,    // è¾¹ç¼˜æ”¶ç¼© (æ¶ˆé™¤ç™½è¾¹å…³é”®)
            brightness: 10,  // é»˜è®¤ç¨å¾®æäº®
            
            // æ‹–æ‹½
            isDragging: false,
            lastX: 0, lastY: 0
        };

        // === 3. åˆå§‹åŒ– ===
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        let selfieSegmentation = null;

        function init() {
            // æ¸²æŸ“å°ºå¯¸æŒ‰é’®
            const sizeList = document.getElementById('size-list');
            for(let k in SIZES) {
                const s = SIZES[k];
                const pill = document.createElement('div');
                pill.className = `size-pill ${k==='1inch'?'active':''}`;
                pill.innerHTML = `${s.name}<span class="size-dim">${s.desc}</span>`;
                pill.onclick = () => {
                    document.querySelectorAll('.size-pill').forEach(el=>el.classList.remove('active'));
                    pill.classList.add('active');
                    state.sizeKey = k;
                    render(); // åˆ‡æ¢å°ºå¯¸ä¸é‡ç½®ä½ç½®ï¼Œä½“éªŒæ›´å¥½
                };
                sizeList.appendChild(pill);
            }
            
            // åŠ è½½æ¨¡å‹
            selfieSegmentation = new SelfieSegmentation({locateFile: (file) => 
                `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
            selfieSegmentation.setOptions({ modelSelection: 1 }); // 1 = Landscape (ç²¾åº¦æ›´é«˜)
            selfieSegmentation.onResults(onAIResults);
        }
        init();

        // === 4. æ–‡ä»¶å¤„ç† ===
        function handleFile(e) {
            const file = e.target.files[0];
            if(!file) return;

            document.getElementById('loading-mask').style.display = 'flex';
            document.getElementById('upload-label').innerText = "AI æ­£åœ¨æ€è€ƒ...";

            const reader = new FileReader();
            reader.onload = (evt) => {
                const img = new Image();
                img.src = evt.target.result;
                img.onload = async () => {
                    state.srcImg = img;
                    state.posX = 0; state.posY = 0; // æ–°å›¾é‡ç½®ä½ç½®
                    await selfieSegmentation.send({image: img});
                };
            };
            reader.readAsDataURL(file);
        }

        function onAIResults(results) {
            // å°† mask ç»˜åˆ¶åˆ°ä¸€ä¸ªç¦»å± canvas å¤‡ç”¨
            const tCan = document.createElement('canvas');
            tCan.width = results.image.width;
            tCan.height = results.image.height;
            const tCtx = tCan.getContext('2d');
            tCtx.drawImage(results.segmentationMask, 0, 0);
            
            const mImg = new Image();
            mImg.src = tCan.toDataURL();
            mImg.onload = () => {
                state.maskImg = mImg;
                autoFit();
                document.getElementById('loading-mask').style.display = 'none';
                document.getElementById('upload-label').innerText = "æ›´æ¢ç…§ç‰‡";
                render();
            };
        }

        // è‡ªåŠ¨é€‚é…å¤§å°
        function autoFit() {
            if(!state.maskImg) return;
            const targetH = SIZES[state.sizeKey].h;
            // é»˜è®¤è®©äººç‰©å ç”»å¸ƒçš„ 80% é«˜åº¦
            state.scale = (targetH * 0.8) / state.maskImg.height;
            state.posY = targetH * 0.1; // ç¨å¾®ä¸‹ç§»
            
            // æ›´æ–°æ»‘æ†
            document.getElementById('scale-slider').value = state.scale;
        }

        // === 5. æ ¸å¿ƒæ¸²æŸ“å¼•æ“ (Pro çº§) ===
        function render() {
            if(!state.srcImg || !state.maskImg) return;
            
            const size = SIZES[state.sizeKey];
            canvas.width = size.w;
            canvas.height = size.h;
            
            const w = canvas.width;
            const h = canvas.height;

            // --- A. ç»˜åˆ¶èƒŒæ™¯ ---
            const bgVal = BACKGROUNDS[state.bgKey];
            if(Array.isArray(bgVal)) {
                const grad = ctx.createLinearGradient(0, 0, 0, h);
                grad.addColorStop(0, bgVal[0]);
                grad.addColorStop(1, bgVal[1]);
                ctx.fillStyle = grad;
            } else {
                ctx.fillStyle = bgVal;
            }
            ctx.fillRect(0, 0, w, h);

            // è®¡ç®—äººåƒç›®æ ‡å°ºå¯¸
            const imgW = state.srcImg.width * state.scale;
            const imgH = state.srcImg.height * state.scale;
            const centerX = w/2;
            const centerY = h/2;
            
            // ç»˜åˆ¶åæ ‡ï¼ˆå±…ä¸­ + åç§»ï¼‰
            const drawX = centerX - imgW/2 + state.posX;
            const drawY = centerY - imgH/2 + state.posY;

            // --- B. å‡†å¤‡ç¦»å± Canvas å¤„ç†äººåƒ ---
            const workCan = document.createElement('canvas');
            workCan.width = w;
            workCan.height = h;
            const workCtx = workCan.getContext('2d');

            // 1. ç»˜åˆ¶è’™ç‰ˆ
            workCtx.drawImage(state.maskImg, drawX, drawY, imgW, imgH);
            
            // 2. è’™ç‰ˆæ”¶ç¼© (Mask Erosion) - æ¶ˆé™¤ç™½è¾¹çš„æ ¸å¿ƒæŠ€å·§
            // åŸç†ï¼šé€šè¿‡å¤šæ¬¡ source-in æ··åˆï¼Œæˆ–è€…ç•¥å¾®ç¼©å°è’™ç‰ˆ
            // è¿™é‡Œä½¿ç”¨ç®€åŒ–çš„ globalCompositeOperation æŠ€å·§ï¼š
            // å°†è’™ç‰ˆè‡ªèº«ç•¥å¾®æ¨¡ç³Šåï¼Œé€šè¿‡é˜ˆå€¼å¤„ç†ï¼Œæˆ–è€…ç®€å•åœ°åˆ©ç”¨ç¼©å°ç»˜åˆ¶
            if(state.erosion > 0) {
                workCtx.globalCompositeOperation = 'source-in';
                // é€šè¿‡ç»˜åˆ¶ä¸€ä¸ªç•¥å¾®ç¼©å°çš„è’™ç‰ˆæ¥ "åˆ‡æ‰" è¾¹ç¼˜
                // æ³¨æ„ï¼šè¿™ä¸ªæ“ä½œæ¯”è¾ƒè€—æ€§èƒ½ï¼Œè¿™é‡Œç”¨ä¸€ç§æ¨¡æ‹Ÿæ–¹å¼ï¼š
                // åˆ©ç”¨ canvas çš„ shadow æ¶ˆé™¤è¾¹ç¼˜åŠé€æ˜åƒç´ 
                // æˆ–è€…ç®€å•ç‚¹ï¼šä¸å¤„ç† maskï¼Œç›´æ¥åœ¨æœ€ååˆæˆæ—¶åš feather
            }

            // --- C. å½±å­å±‚ (è®©ç…§ç‰‡æœ‰ç«‹ä½“æ„Ÿ) ---
            ctx.save();
            ctx.filter = 'blur(8px)'; // å½±å­è¦è™š
            ctx.globalAlpha = 0.2;    // æ·¡æ·¡çš„å½±å­
            ctx.drawImage(workCan, 0, 10); // å½±å­ä¸‹ç§»
            ctx.restore();

            // --- D. åˆæˆäººåƒå±‚ ---
            // æ¸…ç©ºå·¥ä½œåŒºé‡æ–°æ¥
            workCtx.globalCompositeOperation = 'source-over';
            workCtx.clearRect(0,0,w,h);
            
            // 1. ç”»è’™ç‰ˆå¹¶ç¾½åŒ–
            workCtx.filter = `blur(${state.erosion}px)`; // è¾¹ç¼˜ç¾½åŒ–
            // ç•¥å¾®ç¼©å°è’™ç‰ˆç»˜åˆ¶å°ºå¯¸ï¼Œå®ç°â€œæ”¶ç¼©â€
            const shrink = state.erosion * 1.5;
            workCtx.drawImage(state.maskImg, drawX + shrink, drawY + shrink, imgW - shrink*2, imgH - shrink*2);
            workCtx.filter = 'none';

            // 2. å¡«å……äººåƒ (Source-In)
            workCtx.globalCompositeOperation = 'source-in';
            // å¢åŠ äº®åº¦æ»¤é•œ
            workCtx.filter = `brightness(${100 + parseInt(state.brightness)}%) contrast(105%)`;
            workCtx.drawImage(state.srcImg, drawX, drawY, imgW, imgH);
            
            // 3. ç»˜åˆ¶åˆ°ä¸»ç”»å¸ƒ
            ctx.drawImage(workCan, 0, 0);
        }

        // === 6. äº¤äº’é€»è¾‘ ===
        function updateParam(key, val) {
            state[key] = parseFloat(val);
            render();
        }

        function setBg(key, el) {
            state.bgKey = key;
            document.querySelectorAll('.bg-card').forEach(e=>e.classList.remove('active'));
            el.classList.add('active');
            render();
        }

        // æ‹–æ‹½é€»è¾‘ (æ”¯æŒé¼ æ ‡å’Œè§¦æ‘¸)
        const handleStart = (x, y) => { state.isDragging=true; state.lastX=x; state.lastY=y; };
        const handleMove = (x, y) => {
            if(!state.isDragging) return;
            state.posX += (x - state.lastX);
            state.posY += (y - state.lastY);
            state.lastX=x; state.lastY=y;
            render();
        };
        
        canvas.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
        window.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
        window.addEventListener('mouseup', () => state.isDragging=false);

        canvas.addEventListener('touchstart', e => handleStart(e.touches[0].clientX, e.touches[0].clientY), {passive:false});
        window.addEventListener('touchmove', e => { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); }, {passive:false});
        window.addEventListener('touchend', () => state.isDragging=false);

        // æ»šè½®ç¼©æ”¾
        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.05 : 0.05;
            state.scale = Math.max(0.2, Math.min(3.0, state.scale + delta));
            document.getElementById('scale-slider').value = state.scale;
            render();
        });

        // ä¸‹è½½
        function downloadImage() {
            if(!state.srcImg) return alert('è¯·å…ˆä¸Šä¼ ç…§ç‰‡');
            const link = document.createElement('a');
            link.download = `ç«æ˜Ÿè¯ä»¶ç…§_${state.sizeKey}_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
        }

        function showContact() {
            document.getElementById('contact-modal').style.display = 'flex';
        }
    </script>
</body>
</html>
